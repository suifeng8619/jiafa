{%- assign images_metafield = product.metafields.custom['360_images'] -%}
{%- assign has_360_images = false -%}

{%- if images_metafield != blank -%}
  {%- assign image_count = 0 -%}
  {%- for image in images_metafield.value -%}
    {%- assign image_count = image_count | plus: 1 -%}
  {%- endfor -%}
  {%- if image_count > 0 -%}
    {%- assign has_360_images = true -%}
  {%- endif -%}
{%- endif -%}

{%- if has_360_images -%}

<div class="product-detail-drawer product-detail-drawer--360view">
  <button type="button" class="view-360-trigger" data-bs-toggle="modal" data-bs-target="#view-360-drawer">
    <span class="icon icon-360-view">
      <svg xmlns="http://www.w3.org/2000/svg" width="46" height="18" viewBox="0 0 46 18" fill="none">
        <path d="M9.18414 3.30114C4.33931 4.70242 1.25 6.82584 1.25 9.20278C1.25 13.4224 10.9858 16.8431 22.9954 16.8431C35.0051 16.8431 44.7408 13.4224 44.7408 9.20278C44.7408 4.98317 35.0051 1.5625 22.9954 1.5625C20.1956 1.5625 17.5194 1.74841 15.0613 2.08702" stroke="black" stroke-width="1.4" stroke-linecap="round"></path>
        <path d="M5.5 1.49219L9.74853 3.22996L7.27312 7.09547" stroke="black" stroke-width="1.4" stroke-linecap="round"></path>
      </svg>
    </span>360 View
  </button>
</div>

<!-- 360度弹窗 -->
<div class="modal fade" id="view-360-drawer" aria-modal="true" role="dialog" style="display: none;">
  <div class="modal-dialog" role="dialog" aria-labelledby="offcanvas-modal-title">
    <div class="modal-content">
      <div class="modal-header">
        <div class="offcanvas-drawer__header__left">
          <button class="btn offcanvas-drawer__button" data-zoom="true" aria-label="Zoom">
            <span class="icon icon-zoom">
              <svg width="26" height="26" viewBox="0 0 26 26" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="9.82399" cy="9.82422" r="6.94661" transform="rotate(-45 9.82399 9.82422)" stroke="black"></circle>
                <path d="M15.3359 15.0664L19 18.7305" stroke="black" stroke-linecap="square"></path>
                <path d="M9.79883 6.7998L9.79883 12.7998" stroke="black" stroke-linecap="square"></path>
                <path d="M6.79883 9.7998H12.7988" stroke="black" stroke-linecap="square"></path>
              </svg>
            </span>
            Zoom
          </button>
        </div>
        <div class="offcanvas-drawer__title" id="offcanvas-modal-title">360 View</div>
        <div class="offcanvas-drawer__header__right">
          <button class="btn offcanvas-drawer__close" data-bs-dismiss="modal" aria-label="Close">
            <span class="icon icon-cross">
              <svg width="21" height="20" viewBox="0 0 21 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <line x1="5.53324" y1="5.01559" x2="15.2887" y2="14.771" stroke="#1A1A1A"></line>
                <line x1="5.70504" y1="14.7695" x2="15.4605" y2="5.01405" stroke="#1A1A1A"></line>
              </svg>
            </span>
          </button>
        </div>
      </div>
      <div class="modal-body">
        <div class="row offcanvas-drawer__content-holder">
          <div class="js-current-content row offcanvas-drawer__content">
            <div class="view-360-drawer">
              <div class="view-360">
                <div class="view-360__colour-label">{{ product.selected_or_first_available_variant.title }}</div>
                {% render '360-viewer' %}
                
                <div class="view-360__instructions">
                  <span class="icon icon-360-view">
                    <svg xmlns="http://www.w3.org/2000/svg" width="46" height="18" viewBox="0 0 46 18" fill="none">
                      <path d="M9.18414 3.30114C4.33931 4.70242 1.25 6.82584 1.25 9.20278C1.25 13.4224 10.9858 16.8431 22.9954 16.8431C35.0051 16.8431 44.7408 13.4224 44.7408 9.20278C44.7408 4.98317 35.0051 1.5625 22.9954 1.5625C20.1956 1.5625 17.5194 1.74841 15.0613 2.08702" stroke="black" stroke-width="1.4" stroke-linecap="round"></path>
                      <path d="M5.5 1.49219L9.74853 3.22996L7.27312 7.09547" stroke="black" stroke-width="1.4" stroke-linecap="round"></path>
                    </svg>
                  </span>
                  <span>Drag image to spin</span>
                </div> 
              </div>
            </div>
          </div>
          <div class="js-incoming-content row offcanvas-drawer__content"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.product-detail-drawer .view-360-trigger {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 15px 20px;
  background: none;
  border: none;
  cursor: pointer;
  font-size: 16px;
  font-weight: 600;
  color: #333;
  margin: 0 auto;
}

.modal {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100% !important;
  height: 100% !important;
  background: rgba(0, 0, 0, 0) !important;
  z-index: 999999 !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.modal.show {
  display: flex !important;
  opacity: 1 !important;
  visibility: visible !important;
  background: rgba(0, 0, 0, 0.5) !important;
}

.modal-dialog {
  max-width: 90vw;
  width: 600px;
  margin: 0 auto;
  position: relative;
  transform: scale(0.8) translateY(50px);
  transition: all 0.3s ease;
}

.modal.show .modal-dialog {
  transform: scale(1) translateY(0);
}

.modal-content {
  border: none;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  background: white;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px;
  border-bottom: 1px solid #e9ecef;
}

.offcanvas-drawer__header__left {
  display: flex;
  gap: 10px;
}

.offcanvas-drawer__button,
.offcanvas-drawer__close {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s ease;
}

.offcanvas-drawer__title {
  font-size: 18px;
  font-weight: 600;
  color: #333;
}

.modal-body {
  padding: 20px;
}

.view-360 {
  text-align: center;
}

.view-360__colour-label {
  font-size: 16px;
  font-weight: 600;
  color: #333;
}

.view-360__viewer {
  position: relative;
  display: inline-block;
  max-width: 100%;
}

.viewer360-container {
  position: relative;
  display: inline-block;
  width: 100%;
  max-width: 100%;
  height: 100%;
  overflow: hidden;
}

.viewer360-container img {
  width: 100%;
  height: 100%;
  border-radius: 8px;
  object-fit: contain;
  display: block;
}

.viewer360-hint {
  position: absolute;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 14px;
  opacity: 0.8;
}

.view-360__instructions {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 8px;
  margin-top: 20px;
  font-size: 14px;
  color: #666;
}

.icon svg {
  width: auto;
  height: auto;
}

/* Zoom 全屏 */
.modal-dialog.fullscreen {
  max-width: 100vw !important;
  width: 100% !important;
  height: 100vh !important;
  margin: 0 !important;
  transform: none !important;
  top: 0 !important;
  left: 0 !important;
}

.modal-dialog.fullscreen .modal-content {
  border-radius: 0 !important;
  height: 100% !important;
  max-height: 100% !important;
}

@media (max-width: 768px) {
  .modal-dialog {
    max-width: 95vw;
    margin: 15px auto;
  }
  
  .modal-header {
    padding: 15px;
  }
  
  .modal-body {
    padding: 15px;
  }
  
  .viewer360-container {
    height: 350px;
    max-height: 50vh;
  }
  
  .offcanvas-drawer__header__left {
    flex-direction: column;
    gap: 5px;
  }
  
  .offcanvas-drawer__button {
    font-size: 12px;
    padding: 6px 10px;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('view-360-drawer');
  const openButton = document.querySelector('[data-bs-target="#view-360-drawer"]');
  const closeButton = document.querySelector('[data-bs-dismiss="modal"]');
  
  if (modal && modal.parentNode !== document.body) {
    document.body.appendChild(modal);
  }
  
  function openModal() {
    if (modal) {
      if (modal.parentNode !== document.body) {
        document.body.appendChild(modal);
      }
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      modal.offsetHeight;
      modal.classList.add('show');
      
      // 确保默认是小窗模式
      const modalDialog = modal.querySelector('.modal-dialog');
      if (modalDialog) {
        modalDialog.classList.remove('fullscreen');
      }
      
      // 重置按钮为Zoom状态
      const zoomButton = modal.querySelector('[data-zoom="true"]');
      if (zoomButton) {
        zoomButton.innerHTML = `
          <span class="icon icon-zoom">
            <svg width="26" height="26" viewBox="0 0 26 26" fill="none"
              xmlns="http://www.w3.org/2000/svg">
              <circle cx="9.82399" cy="9.82422" r="6.94661"
                transform="rotate(-45 9.82399 9.82422)" stroke="black"></circle>
              <path d="M15.3359 15.0664L19 18.7305" stroke="black"
                stroke-linecap="square"></path>
              <path d="M9.79883 6.7998L9.79883 12.7998" stroke="black"
                stroke-linecap="square"></path>
              <path d="M6.79883 9.7998H12.7988" stroke="black"
                stroke-linecap="square"></path>
            </svg>
          </span>
          Zoom
        `;
      }
    }
  }
  
  function closeModal() {
    if (modal) {
      modal.classList.remove('show');
      document.body.style.overflow = '';
      setTimeout(() => {
        modal.style.display = 'none';
        // 重置图片容器样式
        const viewer360Container = modal.querySelector('.viewer360-container');
        if (viewer360Container) {
          viewer360Container.style.height = '';
          viewer360Container.style.maxHeight = '';
        }
      }, 300);
    }
  }
  
  if (openButton && modal) {
    openButton.addEventListener('click', (e) => {
      e.preventDefault();
      openModal();
    });
  }
  
  if (closeButton && modal) {
    closeButton.addEventListener('click', (e) => {
      e.preventDefault();
      closeModal();
    });
  }
  
  // 点击模态框外部关闭
  let isMouseDownOnModal = false;
  if (modal) {
    modal.addEventListener('mousedown', (e) => {
      if (e.target === modal) {
        const viewer360Container = modal.querySelector('.viewer360-container');
        if (viewer360Container && viewer360Container.dataset.dragging === 'true') {
          isMouseDownOnModal = false;
        } else {
          isMouseDownOnModal = true;
        }
      } else {
        isMouseDownOnModal = false;
      }
    });
    
    modal.addEventListener('mouseup', (e) => {
      if (e.target === modal && isMouseDownOnModal) {
        const viewer360Container = modal.querySelector('.viewer360-container');
        if (!viewer360Container || viewer360Container.dataset.dragging !== 'true') {
          closeModal();
        }
      }
      isMouseDownOnModal = false;
    });
  }
  
  // ESC键关闭
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal.classList.contains('show')) {
      closeModal();
    }
  });

  // Zoom / Back 功能
  const zoomButton = modal.querySelector('[data-zoom="true"]');
  const modalDialog = modal.querySelector('.modal-dialog');
  if (zoomButton && modalDialog) {
    zoomButton.addEventListener('click', () => {
      const isFullscreen = modalDialog.classList.toggle('fullscreen');
      if (isFullscreen) {
        zoomButton.innerHTML = `
          <span class="icon icon-back">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none"
              xmlns="http://www.w3.org/2000/svg">
              <path d="M12 15L7 10L12 5" stroke="black" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
          Back
        `;
      } else {
        zoomButton.innerHTML = `
          <span class="icon icon-zoom">
            <svg width="26" height="26" viewBox="0 0 26 26" fill="none"
              xmlns="http://www.w3.org/2000/svg">
              <circle cx="9.82399" cy="9.82422" r="6.94661"
                transform="rotate(-45 9.82399 9.82422)" stroke="black"></circle>
              <path d="M15.3359 15.0664L19 18.7305" stroke="black"
                stroke-linecap="square"></path>
              <path d="M9.79883 6.7998L9.79883 12.7998" stroke="black"
                stroke-linecap="square"></path>
              <path d="M6.79883 9.7998H12.7988" stroke="black"
                stroke-linecap="square"></path>
            </svg>
          </span>
          Zoom
        `;
      }
    });
  }
});
</script>
{%- endif -%}
